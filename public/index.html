<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Messenger</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Tahoma,Arial,sans-serif;
  background:linear-gradient(#e4e8f2,#cfd7e6);
}
button{
  background:linear-gradient(#5c73d9,#3c4fb3);
  border:1px solid #2c3b8f;
  color:#fff;
  padding:5px 10px;
  cursor:pointer;
}
button:hover{filter:brightness(1.1)}
input,textarea{
  border:1px solid #777;
  padding:5px;
  font-family:inherit;
}

/* верх */
#topbar{
  height:44px;
  background:linear-gradient(#444,#2b2b2b);
  color:#fff;
  display:flex;
  justify-content:flex-end;
  align-items:center;
  padding:0 10px;
}
#profile{display:none;align-items:center;gap:8px}
#profile img{width:26px;height:26px;border-radius:3px;background:#666}

/* лейаут */
#wrapper{display:flex;height:calc(100vh - 44px)}
#sidebar{
  width:260px;
  background:linear-gradient(#f8f9fd,#dbe2f3);
  border-right:1px solid #9aa3b7;
  padding:8px;
}
#content{flex:1;display:flex;flex-direction:column}

/* авторизация */
#auth{
  background:#fff;
  border:1px solid #9aa3b7;
  padding:8px;
}

/* чаты */
#chat-list{list-style:none;padding:0;margin:0}
#chat-list li{
  background:linear-gradient(#fff,#e7ebf7);
  border:1px solid #9aa3b7;
  margin-bottom:6px;
  padding:6px;
  cursor:pointer;
}
#chat-list li.active{
  background:linear-gradient(#d6e0ff,#b9c8ff);
}
.chat-id{font-size:11px;color:#555}
.chat-actions{margin-top:4px}
.chat-actions span{
  font-size:12px;
  color:#3c4fb3;
  cursor:pointer;
}

/* сообщения */
#messages{
  flex:1;
  background:#fff;
  border-bottom:1px solid #9aa3b7;
  overflow-y:auto;
  padding:10px;
}
.message{
  margin-bottom:10px;
  padding-bottom:4px;
  border-bottom:1px dotted #ccc;
}
.author{font-weight:bold;color:#2c3b8f}
.time{font-size:11px;color:#666;margin-left:6px}
.edited{font-size:11px;color:#999;margin-left:6px}
.msg-actions{float:right;font-size:12px}
.msg-actions span{
  cursor:pointer;
  color:#3c4fb3;
  margin-left:6px;
}

/* отправка */
#send{
  padding:8px;
  background:linear-gradient(#eef2fb,#d9e0f1);
}
#send textarea{width:100%;height:60px}
#tools{margin-top:6px;display:flex;gap:6px}

/* статус */
#status{padding:4px 8px;color:#a00000;font-size:13px}
</style>
</head>

<body>

<div id="topbar">
  <div id="profile">
    <img id="avatar">
    <span id="nickname"></span>
    <button id="logout">Выйти</button>
  </div>
</div>

<div id="wrapper">
  <div id="sidebar">

    <div id="auth">
      <b>Вход</b><br><br>
      <input id="nick" placeholder="Ник"><br><br>
      <input id="pass" type="password" placeholder="Пароль"><br><br>
      <button id="login">Войти</button>
      <button id="register">Регистрация</button>
    </div>

    <div id="chats" style="display:none">
      <b>Чаты</b><br><br>
      <ul id="chat-list"></ul>
      <input id="group-name" placeholder="Название группы">
      <button id="create-group">Создать</button>
    </div>

  </div>

  <div id="content">
    <div id="messages"></div>

    <div id="send" style="display:none">
      <textarea id="text"></textarea>
      <div id="tools">
        <button id="send-text">Отправить</button>
        <input type="file" id="img" accept="image/*">
        <button id="send-img">Картинка</button>
        <input type="file" id="aud" accept="audio/*">
        <button id="send-aud">Аудио</button>
      </div>
    </div>

    <div id="status"></div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);

const API={
  login:'/login',
  register:'/register',
  logout:'/logout',
  profile:'/profile',
  groups:'/groups',
  createGroup:'/groups/create',
  deleteGroup:'/groups/delete',
  getText:'/get-text',
  sendText:'/save-text',
  editMsg:'/edit-messege',
  delMsg:'/delete-messege',
  img:'/upload-image',
  aud:'/upload-voice'
};

let currentGroup=null;
let myNick=null;

/* ===== AUTH ===== */
async function auth(url){
  const r=await fetch(url,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({nickname:$('nick').value,password:$('pass').value})
  });
  if(!r.ok)return status(r);
  init();
}
$('login').onclick=()=>auth(API.login);
$('register').onclick=()=>auth(API.register);
$('logout').onclick=async()=>{await fetch(API.logout,{method:'POST'});location.reload();};

async function init(){
  const r=await fetch(API.profile);
  if(!r.ok)return;
  const p=await r.json();
  myNick=p.nickname;
  $('auth').style.display='none';
  $('chats').style.display='block';
  $('profile').style.display='flex';
  $('nickname').textContent=p.nickname;
  $('avatar').src=p.avatar||'';
  loadGroups();
}

/* ===== GROUPS ===== */
async function loadGroups(){
  const r=await fetch(API.groups);
  if(!r.ok)return status(r);
  const g=await r.json();
  $('chat-list').innerHTML='';
  g.forEach(c=>{
    const li=document.createElement('li');
    li.innerHTML=`
      <div>${c.name}</div>
      <div class="chat-id">id: ${c.id}</div>
      ${c.author===myNick?`
      <div class="chat-actions">
        <span onclick="deleteGroup(${c.id})">удалить</span>
      </div>`:''}
    `;
    li.onclick=()=>openChat(c.id,li);
    $('chat-list').appendChild(li);
  });
}

window.deleteGroup=async(id)=>{
  if(!confirm('Удалить группу?'))return;
  const r=await fetch(API.deleteGroup,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({id})
  });
  if(!r.ok)return status(r);
  currentGroup=null;
  $('messages').innerHTML='';
  $('send').style.display='none';
  loadGroups();
};

$('create-group').onclick=async()=>{
  const name=$('group-name').value.trim();
  if(!name)return;
  const r=await fetch(API.createGroup,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({name})
  });
  if(!r.ok)return status(r);
  $('group-name').value='';
  loadGroups();
};

async function openChat(id,li){
  currentGroup=id;
  [...$('chat-list').children].forEach(x=>x.classList.remove('active'));
  li.classList.add('active');
  $('send').style.display='block';
  loadMessages();
}

/* ===== MESSAGES ===== */
async function loadMessages(){
  const r=await fetch(API.getText+'?groupId='+currentGroup);
  if(!r.ok)return status(r);
  const m=await r.json();
  $('messages').innerHTML='';
  m.forEach(msg=>{
    const d=document.createElement('div');
    d.className='message';
    d.innerHTML=`
      <span class="author">${msg.author}</span>
      <span class="time">${msg.time||''}</span>
      ${msg.edited?'<span class="edited">(изменено)</span>':''}
      ${msg.author===myNick?`
      <span class="msg-actions">
        <span onclick="editMsg(${msg.id},\`${msg.content}\`)">✎</span>
        <span onclick="deleteMsg(${msg.id})">✖</span>
      </span>`:''}
      <div>${render(msg)}</div>
    `;
    $('messages').appendChild(d);
  });
  $('messages').scrollTop=1e9;
}

function render(m){
  if(m.type==='image')return`<img src="${m.content}" width="220">`;
  if(m.type==='voice')return`<audio controls src="${m.content}"></audio>`;
  return m.content;
}

window.editMsg=async(id,old)=>{
  const text=prompt('Редактировать сообщение',old);
  if(text===null)return;
  const r=await fetch(API.editMsg,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({id,text})
  });
  if(!r.ok)return status(r);
  loadMessages();
};

window.deleteMsg=async(id)=>{
  if(!confirm('Удалить сообщение?'))return;
  const r=await fetch(API.delMsg,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({id})
  });
  if(!r.ok)return status(r);
  loadMessages();
};

/* ===== SEND ===== */
$('send-text').onclick=async()=>{
  const t=$('text').value.trim();
  if(!t)return;
  const r=await fetch(API.sendText,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({groupId:currentGroup,text:t})
  });
  if(!r.ok)return status(r);
  $('text').value='';
  loadMessages();
};

$('send-img').onclick=async()=>{
  if(!$('img').files.length)return;
  const f=new FormData();
  f.append('image',$('img').files[0]);
  f.append('groupId',currentGroup);
  const r=await fetch(API.img,{method:'POST',body:f});
  if(!r.ok)return status(r);
  $('img').value='';
  loadMessages();
};

$('send-aud').onclick=async()=>{
  if(!$('aud').files.length)return;
  const f=new FormData();
  f.append('voice',$('aud').files[0]);
  f.append('groupId',currentGroup);
  const r=await fetch(API.aud,{method:'POST',body:f});
  if(!r.ok)return status(r);
  $('aud').value='';
  loadMessages();
};

function status(r){ $('status').textContent='Ошибка '+r.status; }

init();
</script>

</body>
</html>
