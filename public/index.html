<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Messenger</title>

<style>
body{
  margin:0;
  font-family:Tahoma,Arial,sans-serif;
  background:#dfe4ef;
}
button{
  padding:5px 10px;
  background:#4b5fbf;
  border:1px solid #2f3e8f;
  color:#fff;
  cursor:pointer;
}
button:hover{background:#3f52a3}
input,textarea{
  border:1px solid #777;
  padding:5px;
  font-family:inherit;
}
#wrapper{display:flex;height:100vh}
#sidebar{
  width:270px;
  background:#eef1f8;
  border-right:1px solid #9aa3b7;
  padding:8px;
}
#content{flex:1;display:flex;flex-direction:column}
#messages{
  flex:1;
  background:#fff;
  padding:10px;
  overflow-y:auto;
}
.message{
  border-bottom:1px dotted #ccc;
  margin-bottom:8px;
}
.author{font-weight:bold;color:#2c3b8f}
.edited{font-size:11px;color:#777;margin-left:6px}
.msg-actions{
  float:right;
  font-size:12px;
}
.msg-actions button{
  background:none;
  border:none;
  color:#2c3b8f;
  padding:0;
}
#send{
  background:#dde3f3;
  padding:8px;
}
#bottom{
  font-size:12px;
  padding:4px 8px;
  background:#cfd6e8;
  border-top:1px solid #9aa3b7;
}
.hidden{display:none}
table{width:100%;font-size:12px}
</style>
</head>

<body>

<div id="wrapper">

<!-- SIDEBAR -->
<div id="sidebar">

<div id="auth">
<b>Вход</b><br><br>
<input id="nick" placeholder="Ник"><br><br>
<input id="pass" type="password" placeholder="Пароль"><br><br>
<button id="login">Войти</button>
<button id="register">Регистрация</button>
</div>

<div id="user" class="hidden">
<b id="user-nick"></b><br><br>

<button id="open-profile">Профиль</button>
<div id="profile" class="hidden">
<br>
<input id="new-nick" placeholder="Новый ник"><br><br>
<input id="old-pass" type="password" placeholder="Старый пароль"><br><br>
<input id="new-pass" type="password" placeholder="Новый пароль"><br><br>
<button id="save-profile">Сохранить</button>
</div>

<hr>

<b>Чаты</b>
<ul id="groups"></ul>

<input id="join-id" placeholder="ID группы"><br><br>
<button id="join-group">Вступить</button><br><br>

<button id="open-create">Создать группу</button>
<div id="create-menu" class="hidden">
<br>
<input id="group-name" placeholder="Название"><br><br>
<button id="create-group">Создать</button>
</div>

<div id="group-admin" class="hidden">
<hr>
<b>Управление группой</b><br><br>
<input id="kick-nick" placeholder="Ник участника"><br><br>
<button id="kick">Кик</button><br><br>
<button id="delete-group">Удалить группу</button>
</div>

</div>

</div>

<!-- CONTENT -->
<div id="content">
<div id="messages"></div>

<div id="send" class="hidden">
<textarea id="text" style="width:100%;height:60px"></textarea><br><br>
<button id="send-text">Отправить</button>
</div>

<div id="bottom">
<table>
<tr>
<td id="date"></td>
<td align="right">Ping: <span id="ping">–</span> ms</td>
</tr>
</table>
</div>
</div>

</div>

<script>
const $=id=>document.getElementById(id);
let currentGroup=null,myNick=null;

/* ping */
$('date').textContent=new Date().toLocaleString();
async function ping(){
  const t=performance.now();
  await fetch('/');
  $('ping').textContent=Math.round(performance.now()-t);
}
setInterval(ping,5000); ping();

/* auth */
async function auth(url){
  const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},
  body:JSON.stringify({nickname:$('nick').value,password:$('pass').value})});
  if(!r.ok)return;
  init();
}
$('login').onclick=()=>auth('/login');
$('register').onclick=()=>auth('/register');

async function init(){
  const r=await fetch('/profile');
  if(!r.ok)return;
  const p=await r.json();
  myNick=p.nickname;
  $('auth').classList.add('hidden');
  $('user').classList.remove('hidden');
  $('user-nick').textContent=p.nickname;
  loadGroups();
}

/* groups */
async function loadGroups(){
  const r=await fetch('/groups');
  const g=await r.json();
  $('groups').innerHTML='';
  g.forEach(gr=>{
    const li=document.createElement('li');
    li.textContent=gr.name+' ('+gr.id+')';
    li.onclick=()=>openGroup(gr);
    $('groups').appendChild(li);
  });
}

function openGroup(gr){
  currentGroup=gr.id;
  $('send').classList.remove('hidden');
  $('group-admin').classList.toggle('hidden',gr.author!==myNick);
  loadMessages();
}

$('open-create').onclick=()=>{
  const m=$('create-menu');
  m.classList.toggle('hidden');
};

$('create-group').onclick=async()=>{
  await fetch('/groups/create',{method:'POST',headers:{'Content-Type':'application/json'},
  body:JSON.stringify({name:$('group-name').value})});
  loadGroups();
};

/* messages */
async function loadMessages(){
  const r=await fetch('/get-text?groupId='+currentGroup);
  const m=await r.json();
  $('messages').innerHTML='';
  m.forEach(msg=>{
    const d=document.createElement('div');
    d.className='message';
    d.innerHTML=`
      <span class="author">${msg.author}</span>
      ${msg.edited?'<span class="edited">(изменено)</span>':''}
      ${msg.author===myNick?`
      <span class="msg-actions">
        <button onclick="editMessage(${msg.id},\`${msg.content}\`)">ред</button>
        <button onclick="deleteMessage(${msg.id})">уд</button>
      </span>`:''}
      <div>${msg.content}</div>`;
    $('messages').appendChild(d);
  });
}

window.editMessage=async(id,old)=>{
  const t=prompt('Редактировать',old);
  if(t===null)return;
  await fetch('/edit-messege',{method:'POST',headers:{'Content-Type':'application/json'},
  body:JSON.stringify({id,text:t})});
  loadMessages();
};

window.deleteMessage=async(id)=>{
  if(!confirm('Удалить сообщение?'))return;
  await fetch('/delete-messege',{method:'POST',headers:{'Content-Type':'application/json'},
  body:JSON.stringify({id})});
  loadMessages();
};

/* send */
$('send-text').onclick=async()=>{
  const t=$('text').value.trim();
  if(!t)return;
  await fetch('/save-text',{method:'POST',headers:{'Content-Type':'application/json'},
  body:JSON.stringify({groupId:currentGroup,text:t})});
  $('text').value='';
  loadMessages();
};

/* admin */
$('kick').onclick=async()=>{
  await fetch('/kick-member',{method:'POST',headers:{'Content-Type':'application/json'},
  body:JSON.stringify({groupId:currentGroup,nickname:$('kick-nick').value})});
};

$('delete-group').onclick=async()=>{
  if(!confirm('Удалить группу?'))return;
  await fetch('/groups/delete',{method:'POST',headers:{'Content-Type':'application/json'},
  body:JSON.stringify({id:currentGroup})});
  currentGroup=null;
  $('messages').innerHTML='';
  $('send').classList.add('hidden');
  loadGroups();
};

init();
</script>

</body>
</html>
