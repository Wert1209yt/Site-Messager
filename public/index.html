<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Бункер</title>

</head>
<body>

<h2>Регистрация</h2>
<input type="text" id="registerNickname" placeholder="Никнейм" required>
<input type="password" id="registerPassword" placeholder="Пароль" required>
<button onclick="register()">Зарегистрироваться</button>

<h2>Вход</h2>
<input type="text" id="loginNickname" placeholder="Никнейм" required>
<input type="password" id="loginPassword" placeholder="Пароль" required>
<button onclick="login()">Войти</button>

<h2>Отправка текста</h2>
<textarea id="textInput" rows="5" cols="50" placeholder="Введите текст здесь"></textarea><br>
<button onclick="saveText()">Сохранить текст</button>

<h2>Тексты пользователей</h2>
<pre id="displayText"></pre>

<script>
let token = '';

async function register() {
    const nickname = document.getElementById('registerNickname').value;
    const password = document.getElementById('registerPassword').value;

    const response = await fetch('/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nickname, password })
    });

    const message = await response.text();
    alert(message);
}

async function login() {
    const nickname = document.getElementById('loginNickname').value;
    const password = document.getElementById('loginPassword').value;

    const response = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nickname, password })
    });

    if (response.ok) {
        const data = await response.json();
        token = data.token; // Сохраняем токен
        alert(`Вы вошли как ${nickname}`);
        
        // Очистка полей после входа
        document.getElementById('loginNickname').value = '';
        document.getElementById('loginPassword').value = '';
        
        // Активируем возможность отправки текста
        document.getElementById('textInput').disabled = false;
        
    } else {
        const message = await response.text();
        alert(message);
    }
}

async function saveText() {
    const text = document.getElementById('textInput').value;

    if (!token) {
        alert('Сначала выполните вход!');
        return;
    }

     // Отправляем текст на сервер с токеном аутентификации
     const response = await fetch('/save-text', {
         method: 'POST',
         headers: {
             'Content-Type': 'application/json',
             'Authorization': `Bearer ${token}`
         },
         body: JSON.stringify({ text })
     });

     const message = await response.text();
     alert(message);
}

// Функция для обновления текста на странице
async function updateDisplayText() {
    const response = await fetch('/get-text');
    
    if (response.ok) {
        const data = await response.text();
        document.getElementById('displayText').innerText = data; // Обновляем содержимое
    } else {
        console.error('Ошибка при получении текста.');
    }
}

// Периодическое обновление текста каждые 5 секунд
setInterval(updateDisplayText, 5000);

</script>

</body>
</html>
