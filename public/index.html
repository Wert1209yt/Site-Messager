<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Messenger</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Tahoma,Arial,sans-serif;
  background:linear-gradient(#e4e8f2,#cfd7e6);
  color:#222;
}

button{
  background:linear-gradient(#5c73d9,#3c4fb3);
  border:1px solid #2c3b8f;
  color:#fff;
  padding:6px 10px;
  cursor:pointer;
  border-radius:3px;
}
button:hover{filter:brightness(1.1)}
button.icon{
  width:36px;
  padding:6px;
  font-weight:bold;
}
button.send::before{content:"‚û§";}
button.clip::before{content:"‚éò";}
button.recording{
  background:linear-gradient(#b94a48,#8b1e1e);
  border-color:#6d1616;
}
.kick-btn{padding:2px 6px;font-size:11px}
.cancel-edit{background:linear-gradient(#dc3545,#c82333);border-color:#bd2130}

input,textarea{
  border:1px solid #777;
  padding:6px;
  font-family:inherit;
  border-radius:3px;
}

#topbar{
  height:44px;
  background:linear-gradient(#444,#2b2b2b);
  color:#fff;
  display:flex;
  justify-content:flex-end;
  align-items:center;
  padding:0 10px;
}
#profile{display:flex;align-items:center;gap:8px}
#nickname{font-weight:bold;cursor:pointer}

#wrapper{display:flex;height:calc(100vh - 44px)}
#sidebar{
  width:260px;
  background:linear-gradient(#f8f9fd,#dbe2f3);
  border-right:1px solid #9aa3b7;
  padding:8px;
}
#content{flex:1;display:flex;flex-direction:column}

#left-info{
  background:#fff;
  border:1px solid #9aa3b7;
  padding:6px;
  font-size:12px;
  margin-top:10px;
}

#auth{
  background:#fff;
  border:1px solid #9aa3b7;
  padding:8px;
}

#chat-list{list-style:none;padding:0;margin:0}
#chat-list li{
  background:linear-gradient(#fff,#e7ebf7);
  border:1px solid #9aa3b7;
  margin-bottom:6px;
  padding:6px;
  cursor:pointer;
  border-radius:4px;
}
#chat-list li.active{
  background:linear-gradient(#d6e0ff,#b9c8ff);
}
.chat-id{font-size:11px;color:#555}
.chat-actions span{
  font-size:12px;
  color:#3c4fb3;
  cursor:pointer;
}

#messages{
  flex:1;
  background:#fff;
  border-bottom:1px solid #9aa3b7;
  overflow-y:auto;
  padding:10px;
}
.message{
  margin-bottom:10px;
  padding-bottom:4px;
  border-bottom:1px dotted #ccc;
}
.author{font-weight:bold;color:#2c3b8f}
.time{font-size:11px;color:#666;margin-left:6px}
.edited{font-size:11px;color:#999;margin-left:6px}
.msg-actions{float:right;font-size:16px}
.msg-actions span{
  cursor:pointer;
  color:#3c4fb3;
  margin-left:6px;
  padding:2px 4px;
  border-radius:3px;
}
.msg-actions span:hover{background:rgba(60,79,179,0.1)}

.audio{
  display:flex;
  align-items:center;
  gap:6px;
}
.audio button{
  width:28px;
  height:28px;
  padding:0;
  border-radius:50%;
}
.audio .bar{
  flex:1;
  height:6px;
  background:#cfd7e6;
  position:relative;
  border-radius:3px;
}
.audio .bar span{
  position:absolute;
  height:100%;
  background:#3c4fb3;
  width:0%;
  border-radius:3px;
}

#send{
  padding:8px;
  background:linear-gradient(#eef2fb,#d9e0f1);
}
#send textarea{width:100%;height:60px}
#tools{margin-top:6px;display:flex;gap:6px}
#tools.editing{justify-content:space-between}

#group-menu{
  display:none;
  background:#fff;
  border:1px solid #9aa3b7;
  padding:8px;
  margin-top:8px;
  border-radius:4px;
}

#profile-menu{
  display:none;
  position:absolute;
  top:44px;
  right:10px;
  background:#fff;
  border:1px solid #9aa3b7;
  padding:12px;
  z-index:100;
  min-width:240px;
  border-radius:4px;
  box-shadow:0 4px 12px rgba(0,0,0,0.15);
}
#profile-menu input{width:100%;margin-bottom:8px}
#profile-menu button{width:100%;margin-top:4px}

#group-actions{display:none;margin-top:10px}
#group-actions input{width:100%;margin-bottom:8px}

#members-modal{
  display:none;
  position:fixed;
  top:10%;
  left:50%;
  transform:translateX(-50%);
  background:#fff;
  border:1px solid #9aa3b7;
  padding:15px;
  min-width:280px;
  z-index:100;
  border-radius:4px;
  box-shadow:0 4px 20px rgba(0,0,0,0.2);
  max-height:70vh;
  overflow-y:auto;
}
#members-list div{margin-bottom:6px;padding:4px}
#members-list div:hover{background:rgba(60,79,179,0.05)}

#join-group{margin-top:10px}
#join-group input{width:100%;margin-bottom:8px}

#status{padding:4px 8px;color:#a00000;font-size:13px}
</style>
</head>

<body>

<div id="topbar">
  <div id="profile">
    <span id="nickname"></span>
  </div>
</div>

<div id="profile-menu">
  <b>–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</b><br><br>
  <input id="edit-nick" placeholder="–ù–æ–≤—ã–π –Ω–∏–∫"><br>
  <input id="old-pass" type="password" placeholder="–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å"><br>
  <input id="new-pass" type="password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å"><br>
  <input id="confirm-pass" type="password" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å"><br>
  <button id="save-profile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><br><br>
  <div style="font-size:11px;color:#777">ID: <span id="profile-id"></span></div>
</div>

<div id="wrapper">
  <div id="sidebar">
    <div id="auth">
      <b>–í—Ö–æ–¥</b><br><br>
      <input id="nick" placeholder="–ù–∏–∫"><br><br>
      <input id="pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å"><br><br>
      <button id="login">–í–æ–π—Ç–∏</button>
      <button id="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>

    <div id="chats" style="display:none">
      <b>–ß–∞—Ç—ã</b><br><br>
      <ul id="chat-list"></ul>

      <button id="open-group-menu" class="icon">+</button>
      <div id="group-menu">
        <input id="group-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" style="width:100%">
        <button id="create-group">–°–æ–∑–¥–∞—Ç—å</button>
      </div>

      <div id="group-actions">
        <input id="edit-group-name" placeholder="–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"><br>
        <button id="update-group">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ</button><br>
        <button id="show-members">–£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
      </div>

      <div id="members-modal">
        <b>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã</b><br><br>
        <div id="members-list"></div>
        <button onclick="$('members-modal').style.display='none'" style="float:right">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div id="join-group">
        <b>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –≥—Ä—É–ø–ø–µ</b><br><br>
        <input id="join-id" placeholder="ID –≥—Ä—É–ø–ø—ã"><br>
        <button id="join-btn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
      </div>

      <div id="left-info">
        <div id="date"></div>
        <div>Ping: <span id="ping">‚Äì</span> ms</div>
      </div>
    </div>
  </div>

  <div id="content">
    <div id="messages"></div>
    <div id="send" style="display:none">
      <textarea id="text"></textarea>
      <div id="tools">
        <input type="file" id="file" accept="image/*,audio/*" hidden>
        <div>
          <button class="icon clip" id="pick-file"></button>
          <button id="record">üé§</button>
        </div>
        <div id="send-buttons">
          <button class="cancel-edit icon" id="cancel-edit" title="–û—Ç–º–µ–Ω–∞" style="display:none">‚úï</button>
          <button class="icon send" id="send-text">‚û§</button>
        </div>
      </div>
    </div>
    <div id="status"></div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const API={
  login:'/login',register:'/register',profile:'/profile',
  groups:'/groups',createGroup:'/groups/create',deleteGroup:'/groups/:groupId/delete',
  getText:'/get-text',sendText:'/save-text',
  edit:'/edit-message',del:'/delete-my-message',
  img:'/upload-image',aud:'/upload-voice',
  changeNick:'/change-nickname',changePass:'/change-password',
  groupRename:'/groups/:groupId/rename',groupJoin:'/groups/:groupId/join'
};

let currentGroup=null,myNick=null,currentLi=null;
let editingId=null,mediaRecorder=null,audioChunks=[];

/* AUTO-LOGIN ON PAGE LOAD */
window.onload=()=>{
  checkAuth();
  $('date').textContent=new Date().toLocaleDateString();
};

async function checkAuth(){
  try{
    const r=await fetch(API.profile);
    if(r.ok){
      const p=await r.json();
      myNick=p.nickname;
      $('profile-id').textContent=p.id;
      $('auth').style.display='none';
      $('chats').style.display='block';
      $('nickname').textContent=p.nickname;
      loadGroups();
    }
  }catch{}
}

/* DATE + PING */
async function ping(){
  const t=performance.now();
  try{await fetch('/');$('ping').textContent=Math.round(performance.now()-t);}
  catch{}
}
setInterval(ping,5000); ping();

/* AUTH */
async function auth(url){
  const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},
  body:JSON.stringify({nickname:$('nick').value,password:$('pass').value})});
  if(!r.ok)return status(r);
  checkAuth();
}
$('login').onclick=()=>auth(API.login);
$('register').onclick=()=>auth(API.register);

async function init(){
  const r=await fetch(API.profile); 
  if(!r.ok){$('auth').style.display='block';$('chats').style.display='none';return;}
  const p=await r.json(); 
  myNick=p.nickname;
  $('profile-id').textContent=p.id;
  $('auth').style.display='none';
  $('chats').style.display='block';
  $('nickname').textContent=p.nickname;
  loadGroups();
}

/* GROUPS */
$('open-group-menu').onclick=()=>$('group-menu').style.display=
  $('group-menu').style.display==='block'?'none':'block';

$('create-group').onclick=async()=>{
  const n=$('group-name').value.trim(); if(!n)return;
  const r=await fetch(API.createGroup,{method:'POST',headers:{'Content-Type':'application/json'},
  body:JSON.stringify({name:n})});
  if(!r.ok)return status(r);
  $('group-name').value=''; loadGroups();
  $('group-menu').style.display='none';
};

async function loadGroups(){
  const r=await fetch(API.groups); if(!r.ok)return status(r);
  const g=await r.json(); $('chat-list').innerHTML='';
  g.forEach(c=>{
    const li=document.createElement('li');
    li.innerHTML=`<div>${c.name}</div><div class="chat-id">id: ${c.id}</div>
    ${c.creator===myNick?`<div class="chat-actions">
    <span onclick="delGroup('${c.id}')">‚ùå —É–¥–∞–ª–∏—Ç—å</span></div>`:''}`;
    li.onclick=()=>openChat(c.id,li);
    $('chat-list').appendChild(li);
  });
}

window.delGroup=async(id)=>{
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?'))return;
  const r=await fetch(`/groups/${id}/delete`,{method:'POST',headers:{'Content-Type':'application/json'},
  body:JSON.stringify({})});
  if(!r.ok)return status(r);
  loadGroups(); $('messages').innerHTML=''; $('send').style.display='none';
  currentGroup=null;
};

function openChat(id,li){
  currentGroup=id; currentLi=li;
  [...$('chat-list').children].forEach(x=>x.classList.remove('active'));
  li.classList.add('active');
  $('send').style.display='block';
  $('group-actions').style.display=li.querySelector('.chat-actions')?'block':'none';
  $('edit-group-name').value=li.querySelector('div').textContent.trim();
  loadMessages();
}

/* MESSAGES */
async function loadMessages(){
  const r=await fetch(API.getText+'?groupId='+currentGroup);
  if(!r.ok)return status(r);
  const m=await r.json(); $('messages').innerHTML='';
  m.forEach(msg=>{
    const d=document.createElement('div'); d.className='message';
    const time=new Date(msg.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    d.innerHTML=`
      <span class="author">${msg.author}</span>
      <span class="time">${time}</span>
      ${msg.edited?'<span class="edited">(–∏–∑–º–µ–Ω–µ–Ω–æ)</span>':''}
      ${msg.author===myNick?`
      <span class="msg-actions">
        <span onclick="editMsg('${msg.id}',\`${msg.content||''}\`)" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</span>
        <span onclick="delMsg('${msg.id}')" title="–£–¥–∞–ª–∏—Ç—å">üóë</span>
      </span>`:''}
      <div>${render(msg)}</div>`;
    $('messages').appendChild(d);
  });
  $('messages').scrollTop=1e9;
}

function render(m){
  if(m.type==='image')return `<img src="${m.content}" width="220" style="border-radius:8px">`;
  if(m.type==='voice')return audio(m.content);
  return m.content.replace(/\n/g,'<br>');
}

function audio(src){
  return `<div class="audio">
    <button onclick="play(this,'${src}')">‚ñ∂</button>
    <div class="bar"><span></span></div>
  </div>`;
}

window.play=(b,src)=>{
  const a=new Audio(src);
  const bar=b.nextElementSibling.firstChild;
  a.ontimeupdate=()=>bar.style.width=(a.currentTime/a.duration*100)+'%';
  a.onended=()=>b.textContent='‚ñ∂';
  if(b.textContent==='‚ñ∂'){b.textContent='‚è∏';a.play();}
  else{a.pause();b.textContent='‚ñ∂';}
};

/* SEND & EDIT */
$('send-text').onclick=async()=>{
  if(editingId){
    const t=$('text').value.trim();
    if(!t)return;
    const r=await fetch(API.edit,{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({messageId:editingId,newContent:t,groupId:currentGroup})});
    if(!r.ok){status(r);return;}
  }else{
    const t=$('text').value.trim(); if(!t)return;
    const r=await fetch(API.sendText,{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({text:t,groupId:currentGroup})});
    if(!r.ok){status(r);return;}
  }
  cancelEdit();
  $('text').value='';
  loadMessages();
};

$('cancel-edit').onclick=cancelEdit;

function cancelEdit(){
  editingId=null;
  $('tools').classList.remove('editing');
  $('cancel-edit').style.display='none';
  $('send-text').textContent='‚û§';
  $('send-text').classList.remove('cancel-edit');
  $('text').value='';
}

window.editMsg=(id,text)=>{
  editingId=id;
  $('text').value=text;
  $('text').focus();
  $('tools').classList.add('editing');
  $('cancel-edit').style.display='inline-block';
  $('send-text').textContent='‚úì';
  $('send-text').classList.add('cancel-edit');
};

window.delMsg=async(id)=>{
  if(!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?'))return;
  const r=await fetch(API.del,{method:'POST',headers:{'Content-Type':'application/json'},
  body:JSON.stringify({messageId:id,groupId:currentGroup})});
  if(r.ok)loadMessages();
};

/* AUDIO RECORDING */
$('record').onclick=async()=>{
  const btn=$('record');
  if(mediaRecorder&&mediaRecorder.state==='recording'){
    mediaRecorder.stop(); btn.classList.remove('recording'); btn.textContent='üé§'; return;
  }
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder=new MediaRecorder(stream,{mimeType:'audio/webm;codecs=opus'});
    audioChunks=[];
    mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
    mediaRecorder.onstop=async()=>{
      const blob=new Blob(audioChunks,{type:'audio/webm;codecs=opus'});
      const fd=new FormData(); fd.append('voice',blob,'voice.webm'); fd.append('groupId',currentGroup);
      const r=await fetch(API.aud,{method:'POST',body:fd});
      if(r.ok)loadMessages();
    };
    mediaRecorder.start(1000); btn.classList.add('recording'); btn.textContent='‚èπ';
  }catch(err){status({status:'–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞'});}
};

/* FILES */
$('pick-file').onclick=()=>$('file').click();
$('file').onchange=async()=>{
  const f=$('file').files[0]; if(!f)return;
  const fd=new FormData(); fd.append(f.type.startsWith('image')?'image':'voice',f); fd.append('groupId',currentGroup);
  const url=f.type.startsWith('image')?API.img:API.aud;
  const r=await fetch(url,{method:'POST',body:fd});
  if(r.ok){$('file').value='';loadMessages();}
};

/* PROFILE MENU */
$('nickname').onclick=()=>{
  $('profile-menu').style.display=$('profile-menu').style.display==='block'?'none':'block';
};
document.onclick=e=>{
  const menu=$('profile-menu');
  if(!menu.contains(e.target)&&e.target!==$('nickname'))menu.style.display='none';
};

$('save-profile').onclick=async()=>{
  const newNick=$('edit-nick').value.trim();
  const oldPass=$('old-pass').value;
  const newPass=$('new-pass').value;
  const confirm=$('confirm-pass').value;
  
  if(newPass&&newPass!==confirm){status({status:'–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'});return;}
  
  if(newNick){
    const r=await fetch(API.changeNick,{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({newNickname:newNick,currentPassword:oldPass})});
    if(!r.ok){status(r);return;}
    const p=await r.json(); myNick=p.newNickname;
    $('nickname').textContent=p.newNickname; loadGroups();
  }
  
  if(newPass){
    const r=await fetch(API.changePass,{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({currentPassword:oldPass,newPassword:newPass})});
    if(!r.ok){status(r);return;}
  }
  
  $('profile-menu').style.display='none';
  $('edit-nick').value='';$('old-pass').value='';$('new-pass').value='';$('confirm-pass').value='';
};

/* GROUP ACTIONS */
$('update-group').onclick=async()=>{
  const name=$('edit-group-name').value.trim();
  if(!name)return;
  const r=await fetch(`/groups/${currentGroup}/rename`,{method:'POST',headers:{'Content-Type':'application/json'},
  body:JSON.stringify({newName:name})});
  if(r.ok){currentLi.querySelector('div').textContent=name;status({status:'–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ'});}
};

$('show-members').onclick=async()=>{
  const r=await fetch(`/groups/${currentGroup}`);
  if(!r.ok){status(r);return;}
  const group=await r.json();
  const list=$('members-list'); list.innerHTML='';
  group.members.forEach(m=>{
    const div=document.createElement('div');
    div.innerHTML=`${m} ${m!==myNick?`<button class="kick-btn" data-nick="${m}">–∫–∏–Ω—É—Ç—å</button>`:''}`;
    list.appendChild(div);
  });
  $('members-modal').style.display='block';
};

$('join-btn').onclick=async()=>{
  const id=$('join-id').value.trim();
  if(!id){status({status:'–í–≤–µ–¥–∏—Ç–µ ID'});return;}
  const r=await fetch(`/groups/${id}/join`,{method:'POST',headers:{'Content-Type':'application/json'},
  body:JSON.stringify({})});
  if(r.ok){
    loadGroups();
    $('join-id').value='';
    status({status:'‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –≥—Ä—É–ø–ø–µ'});
  }else status(r);
};

/* EVENT HANDLERS */
document.addEventListener('click',e=>{
  if(e.target.classList.contains('kick-btn')){
    const nick=e.target.dataset.nick;
    if(!confirm(`–ö–∏–Ω—É—Ç—å ${nick}?`))return;
    fetch(`/groups/${currentGroup}/remove-member`,{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({memberNickname:nick})})
    .then(r=>r.ok?loadMessages():status(r));
  }
});

/* STATUS */
function status(r){
  const msg=r.status?r.status+' '+r.statusText:r.status||'–û—à–∏–±–∫–∞';
  $('status').textContent=msg;
  setTimeout(()=>$('status').textContent='',3e3);
}
</script>

</body>
</html>
