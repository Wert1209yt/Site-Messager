<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Messenger</title>

<style>
/* ===== БАЗА (ФОРУМ 2010–2014) ===== */
body{
  margin:0;
  font-family:Tahoma, Arial, sans-serif;
  background:#d7dbea;
  color:#000;
}
a{color:#1a3dc1;text-decoration:none}
a:hover{text-decoration:underline}
button{
  font-family:inherit;
  background:#4f64c8;
  border:1px solid #2f3f91;
  color:#fff;
  padding:4px 10px;
  cursor:pointer;
}
button:hover{background:#3e52ad}
input, textarea{
  font-family:inherit;
  border:1px solid #777;
  padding:4px;
}
.hidden{display:none}

/* ===== ВЕРХНЕЕ МЕНЮ ===== */
#topbar{
  background:#c7cde4;
  border-bottom:1px solid #8e96b8;
  padding:6px 10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
#topbar span{font-weight:bold}

/* ===== ОСНОВНАЯ СЕТКА ===== */
#wrapper{
  display:flex;
  height:calc(100vh - 34px);
}
#left{
  width:260px;
  background:#eef1fb;
  border-right:1px solid #9aa3c4;
  padding:8px;
  box-sizing:border-box;
}
#right{
  flex:1;
  display:flex;
  flex-direction:column;
}

/* ===== СПИСОК ГРУПП ===== */
#groups{
  list-style:none;
  padding:0;
  margin:0;
}
#groups li{
  padding:4px;
  border-bottom:1px dotted #aaa;
  cursor:pointer;
}
#groups li small{
  display:block;
  color:#666;
  font-size:11px;
}

/* ===== СООБЩЕНИЯ ===== */
#messages{
  flex:1;
  background:#fff;
  padding:10px;
  overflow-y:auto;
}
.message{
  border-bottom:1px dotted #ccc;
  padding-bottom:6px;
  margin-bottom:6px;
}
.author{font-weight:bold;color:#243a9a}
.edited{font-size:11px;color:#666;margin-left:6px}
.actions{
  float:right;
  font-size:12px;
}
.actions button{
  background:none;
  border:none;
  color:#243a9a;
  padding:0 4px;
}

/* ===== ВВОД ===== */
#send{
  border-top:1px solid #9aa3c4;
  background:#dde2f4;
  padding:6px;
}
#send textarea{
  width:100%;
  height:60px;
  box-sizing:border-box;
}
#sendbar{
  margin-top:4px;
  display:flex;
  justify-content:space-between;
}

/* ===== АУДИО ===== */
.audio{
  display:flex;
  align-items:center;
  gap:6px;
}
.audio button{
  width:28px;
  padding:2px 0;
}

/* ===== НИЗ ===== */
#bottom{
  font-size:12px;
  background:#c7cde4;
  border-top:1px solid #8e96b8;
  padding:4px 8px;
}
</style>
</head>

<body>

<div id="topbar">
  <span id="me">Гость</span>
  <span id="status">не подключён</span>
</div>

<div id="wrapper">

<!-- ЛЕВО -->
<div id="left">

<b>Сегодня:</b> <span id="date"></span><br>
<b>Ping:</b> <span id="ping">–</span> ms
<hr>

<b>Чаты</b>
<ul id="groups"></ul>

<hr>
<input id="joinId" placeholder="ID группы">
<button id="joinBtn">Войти</button>

<br><br>
<button id="openCreate">Создать группу</button>
<div id="createBox" class="hidden">
<br>
<input id="groupName" placeholder="Название группы"><br><br>
<button id="createBtn">Создать</button>
</div>

<div id="adminBox" class="hidden">
<hr>
<b>Управление</b><br><br>
<input id="kickNick" placeholder="Ник"><br><br>
<button id="kickBtn">Кик</button><br><br>
<button id="deleteGroup">Удалить группу</button>
</div>

</div>

<!-- ПРАВО -->
<div id="right">

<div id="messages"></div>

<div id="send" class="hidden">
<textarea id="text"></textarea>
<div id="sendbar">
  <div>
    <button id="attach">Скрепка</button>
    <button id="record">Запись</button>
  </div>
  <button id="sendBtn">Отправить</button>
</div>
<input type="file" id="file" class="hidden">
</div>

<div id="bottom">
<span id="bottomInfo"></span>
</div>

</div>

<script>
/* ===== БАЗА ===== */
const $=i=>document.getElementById(i);
let myNick=null;
let currentGroup=null;
let editId=null;
let attachFile=null;
let audioBlob=null;

/* ===== ДАТА / ПИНГ ===== */
$('date').textContent=new Date().toLocaleDateString();
async function ping(){
  const t=performance.now();
  try{await fetch('/');$('ping').textContent=Math.round(performance.now()-t);}
  catch{}
}
ping();setInterval(ping,5000);

/* ===== АВТОВХОД ===== */
(async()=>{
  const r=await fetch('/profile');
  if(!r.ok)return;
  const p=await r.json();
  myNick=p.nickname;
  $('me').textContent=myNick;
  $('status').textContent='онлайн';
  loadGroups();
})();

/* ===== ГРУППЫ ===== */
async function loadGroups(){
  const r=await fetch('/groups');
  if(!r.ok)return;
  const g=await r.json();
  $('groups').innerHTML='';
  g.forEach(gr=>{
    const li=document.createElement('li');
    li.innerHTML=`${gr.name}<small>${gr.id}</small>`;
    li.onclick=()=>openGroup(gr);
    $('groups').appendChild(li);
  });
}

function openGroup(gr){
  currentGroup=gr.id;
  $('send').classList.remove('hidden');
  $('adminBox').classList.toggle('hidden',gr.author!==myNick);
  loadMessages();
}

/* ===== СООБЩЕНИЯ ===== */
async function loadMessages(){
  const r=await fetch('/get-text?groupId='+currentGroup);
  if(!r.ok)return;
  const m=await r.json();
  $('messages').innerHTML='';
  m.forEach(msg=>{
    const d=document.createElement('div');
    d.className='message';
    d.innerHTML=`
      <span class="author">${msg.author}</span>
      ${msg.edited?'<span class="edited">(изменено)</span>':''}
      ${msg.author===myNick?`
        <span class="actions">
          <button onclick="editMsg(${msg.id},\`${msg.content||''}\`)">ред</button>
          <button onclick="delMsg(${msg.id})">уд</button>
        </span>`:''}
      <div>${render(msg)}</div>
    `;
    $('messages').appendChild(d);
  });
  $('messages').scrollTop=$('messages').scrollHeight;
}

function render(msg){
  if(msg.type==='image')
    return `<img src="${msg.url}" style="max-width:300px">`;
  if(msg.type==='audio')
    return `<div class="audio">
      <button onclick="play(this)">▶</button>
      <audio src="${msg.url}"></audio>
    </div>`;
  return msg.content;
}

function play(b){
  const a=b.nextElementSibling;
  a.paused?a.play():a.pause();
}

/* ===== РЕД / УД ===== */
window.editMsg=(id,text)=>{
  editId=id;
  $('text').value=text;
};
window.delMsg=async(id)=>{
  if(!confirm('Удалить?'))return;
  await fetch('/delete-messege',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});
  loadMessages();
};

/* ===== ОТПРАВКА ===== */
$('sendBtn').onclick=async()=>{
  if(editId){
    await fetch('/edit-messege',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({id:editId,text:$('text').value})});
    editId=null;
    $('text').value='';
    loadMessages();
    return;
  }
  if($('text').value.trim()){
    await fetch('/save-text',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({groupId:currentGroup,text:$('text').value})});
  }
  if(attachFile){
    const f=new FormData();
    f.append('file',attachFile);
    f.append('groupId',currentGroup);
    await fetch('/upload',{method:'POST',body:f});
    attachFile=null;
  }
  if(audioBlob){
    const f=new FormData();
    f.append('file',audioBlob,'record.webm');
    f.append('groupId',currentGroup);
    await fetch('/upload',{method:'POST',body:f});
    audioBlob=null;
  }
  $('text').value='';
  loadMessages();
};

/* ===== ФАЙЛ / ЗАПИСЬ ===== */
$('attach').onclick=()=>$('file').click();
$('file').onchange=()=>attachFile=$('file').files[0];

let rec=null,chunks=[];
$('record').onclick=async()=>{
  if(!rec){
    const s=await navigator.mediaDevices.getUserMedia({audio:true});
    rec=new MediaRecorder(s);
    chunks=[];
    rec.ondataavailable=e=>chunks.push(e.data);
    rec.onstop=()=>audioBlob=new Blob(chunks,{type:'audio/webm'});
    rec.start();
    $('record').textContent='Стоп';
  }else{
    rec.stop();
    rec=null;
    $('record').textContent='Запись';
  }
};

/* ===== СОЗДАНИЕ / КИК ===== */
$('openCreate').onclick=()=>$('createBox').classList.toggle('hidden');
$('createBtn').onclick=async()=>{
  await fetch('/groups/create',{method:'POST',headers:{'Content-Type':'application/json'},
  body:JSON.stringify({name:$('groupName').value})});
  loadGroups();
};
$('kickBtn').onclick=async()=>{
  await fetch('/kick-member',{method:'POST',headers:{'Content-Type':'application/json'},
  body:JSON.stringify({groupId:currentGroup,nickname:$('kickNick').value})});
};
$('deleteGroup').onclick=async()=>{
  if(!confirm('Удалить группу?'))return;
  await fetch('/groups/delete',{method:'POST',headers:{'Content-Type':'application/json'},
  body:JSON.stringify({id:currentGroup})});
  currentGroup=null;
  $('messages').innerHTML='';
  $('send').classList.add('hidden');
  loadGroups();
};
</script>

</body>
</html>
