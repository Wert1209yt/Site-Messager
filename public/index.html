<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Messenger</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Tahoma,Arial,sans-serif;
  background:linear-gradient(#e4e8f2,#cfd7e6);
  color:#222;
}

/* ===== КНОПКИ ===== */
button{
  background:linear-gradient(#5c73d9,#3c4fb3);
  border:1px solid #2c3b8f;
  color:#fff;
  padding:6px 10px;
  cursor:pointer;
}
button:hover{filter:brightness(1.1)}
button.icon{
  width:36px;
  padding:6px;
  font-weight:bold;
}
button.send::before{content:"➤";}
button.clip::before{content:"⎘";}
button.recording{
  background:linear-gradient(#b94a48,#8b1e1e);
  border-color:#6d1616;
}

/* ===== INPUT ===== */
input,textarea{
  border:1px solid #777;
  padding:6px;
  font-family:inherit;
}

/* ===== TOP ===== */
#topbar{
  height:44px;
  background:linear-gradient(#444,#2b2b2b);
  color:#fff;
  display:flex;
  justify-content:flex-end;
  align-items:center;
  padding:0 10px;
}
#profile{display:flex;align-items:center;gap:8px}
/* аватар удалён */
#nickname{font-weight:bold;}

/* ===== LAYOUT ===== */
#wrapper{display:flex;height:calc(100vh - 44px)}
#sidebar{
  width:260px;
  background:linear-gradient(#f8f9fd,#dbe2f3);
  border-right:1px solid #9aa3b7;
  padding:8px;
}
#content{flex:1;display:flex;flex-direction:column}

/* ===== LEFT INFO ===== */
#left-info{
  background:#fff;
  border:1px solid #9aa3b7;
  padding:6px;
  font-size:12px;
  margin-top:10px;
}

/* ===== AUTH ===== */
#auth{
  background:#fff;
  border:1px solid #9aa3b7;
  padding:8px;
}

/* ===== GROUPS ===== */
#chat-list{list-style:none;padding:0;margin:0}
#chat-list li{
  background:linear-gradient(#fff,#e7ebf7);
  border:1px solid #9aa3b7;
  margin-bottom:6px;
  padding:6px;
  cursor:pointer;
}
#chat-list li.active{
  background:linear-gradient(#d6e0ff,#b9c8ff);
}
.chat-id{font-size:11px;color:#555}
.chat-actions span{
  font-size:12px;
  color:#3c4fb3;
  cursor:pointer;
}

/* ===== MESSAGES ===== */
#messages{
  flex:1;
  background:#fff;
  border-bottom:1px solid #9aa3b7;
  overflow-y:auto;
  padding:10px;
}
.message{
  margin-bottom:10px;
  padding-bottom:4px;
  border-bottom:1px dotted #ccc;
}
.author{font-weight:bold;color:#2c3b8f}
.time{font-size:11px;color:#666;margin-left:6px}
.edited{font-size:11px;color:#999;margin-left:6px}
.msg-actions{float:right;font-size:12px}
.msg-actions span{
  cursor:pointer;
  color:#3c4fb3;
  margin-left:6px;
}

/* ===== AUDIO PLAYER ===== */
.audio{
  display:flex;
  align-items:center;
  gap:6px;
}
.audio button{
  width:28px;
  height:28px;
  padding:0;
}
.audio .bar{
  flex:1;
  height:6px;
  background:#cfd7e6;
  position:relative;
}
.audio .bar span{
  position:absolute;
  height:100%;
  background:#3c4fb3;
  width:0%;
}

/* ===== SEND ===== */
#send{
  padding:8px;
  background:linear-gradient(#eef2fb,#d9e0f1);
}
#send textarea{width:100%;height:60px}
#tools{margin-top:6px;display:flex;gap:6px}

/* ===== GROUP MENU ===== */
#group-menu{
  display:none;
  background:#fff;
  border:1px solid #9aa3b7;
  padding:8px;
  margin-top:8px;
}

/* ===== STATUS ===== */
#status{padding:4px 8px;color:#a00000;font-size:13px}
</style>
</head>

<body>

<div id="topbar">
  <div id="profile">
    <span id="nickname"></span>
  </div>
</div>

<div id="wrapper">
  <div id="sidebar">

    <div id="auth">
      <b>Вход</b><br><br>
      <input id="nick" placeholder="Ник"><br><br>
      <input id="pass" type="password" placeholder="Пароль"><br><br>
      <button id="login">Войти</button>
      <button id="register">Регистрация</button>
    </div>

    <div id="chats" style="display:none">
      <b>Чаты</b><br><br>
      <ul id="chat-list"></ul>

      <button id="open-group-menu" class="icon">+</button>
      <div id="group-menu">
        <input id="group-name" placeholder="Название группы" style="width:100%">
        <div style="margin-top:10px"></div>
        <button id="create-group">Создать</button>
      </div>

      <div id="left-info">
        <div id="date"></div>
        <div>Ping: <span id="ping">–</span> ms</div>
      </div>
    </div>

  </div>

  <div id="content">
    <div id="messages"></div>

    <div id="send" style="display:none">
      <textarea id="text"></textarea>
      <div id="tools">
        <input type="file" id="file" accept="image/*,audio/*" hidden>
        <button class="icon clip" id="pick-file"></button>
        <button id="record">Запись</button>
        <button class="icon send" id="send-text"></button>
      </div>
    </div>

    <div id="status"></div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const API={
  login:'/login',register:'/register',logout:'/logout',profile:'/profile',
  groups:'/groups',createGroup:'/groups/create',deleteGroup:'/groups/delete',
  getText:'/get-text',sendText:'/save-text',
  edit:'/edit-messege',del:'/delete-messege',
  img:'/upload-image',aud:'/upload-voice'
};

let currentGroup=null,myNick=null;
let editingId=null;

/* DATE + PING */
$('date').textContent=new Date().toLocaleDateString();
async function ping(){
  const t=performance.now();
  try{await fetch('/');$('ping').textContent=Math.round(performance.now()-t);}
  catch{}
}
setInterval(ping,5000); ping();

/* AUTH */
async function auth(url){
  const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},
  body:JSON.stringify({nickname:$('nick').value,password:$('pass').value})});
  if(!r.ok)return status(r);
  init();
}
$('login').onclick=()=>auth(API.login);
$('register').onclick=()=>auth(API.register);

async function init(){
  const r=await fetch(API.profile); if(!r.ok)return;
  const p=await r.json(); myNick=p.nickname;
  $('auth').style.display='none';
  $('chats').style.display='block';
  $('nickname').textContent=p.nickname;
  loadGroups();
}

/* GROUPS */
$('open-group-menu').onclick=()=>$('group-menu').style.display=
  $('group-menu').style.display==='block'?'none':'block';

$('create-group').onclick=async()=>{
  const n=$('group-name').value.trim(); if(!n)return;
  const r=await fetch(API.createGroup,{method:'POST',headers:{'Content-Type':'application/json'},
  body:JSON.stringify({name:n})});
  if(!r.ok)return status(r);
  $('group-name').value=''; loadGroups();
};

async function loadGroups(){
  const r=await fetch(API.groups); if(!r.ok)return status(r);
  const g=await r.json(); $('chat-list').innerHTML='';
  g.forEach(c=>{
    const li=document.createElement('li');
    li.innerHTML=`<div>${c.name}</div><div class="chat-id">id: ${c.id}</div>
    ${c.author===myNick?`<div class="chat-actions">
    <span onclick="delGroup(${c.id})">удалить</span></div>`:''}`;
    li.onclick=()=>openChat(c.id,li);
    $('chat-list').appendChild(li);
  });
}
window.delGroup=async(id)=>{
  if(!confirm('Удалить группу?'))return;
  const r=await fetch(API.deleteGroup,{method:'POST',headers:{'Content-Type':'application/json'},
  body:JSON.stringify({id})});
  if(!r.ok)return status(r);
  loadGroups(); $('messages').innerHTML=''; $('send').style.display='none';
};

function openChat(id,li){
  currentGroup=id;
  [...$('chat-list').children].forEach(x=>x.classList.remove('active'));
  li.classList.add('active');
  $('send').style.display='block';
  loadMessages();
}

/* MESSAGES */
async function loadMessages(){
  const r=await fetch(API.getText+'?groupId='+currentGroup);
  if(!r.ok)return status(r);
  const m=await r.json(); $('messages').innerHTML='';
  m.forEach(msg=>{
    const d=document.createElement('div'); d.className='message';
    d.innerHTML=`
      <span class="author">${msg.author}</span>
      <span class="time">${msg.time||''}</span>
      ${msg.edited?'<span class="edited">(изменено)</span>':''}
      ${msg.author===myNick?`
      <span class="msg-actions">
        <span onclick="editMsg(${msg.id},\`${msg.content||''}\`)">ред</span>
        <span onclick="delMsg(${msg.id})">уд</span>
      </span>`:''}
      <div>${render(msg)}</div>`;
    $('messages').appendChild(d);
  });
  $('messages').scrollTop=1e9;
}

function render(m){
  if(m.type==='image')return `<img src="${m.content}" width="220">`;
  if(m.type==='voice')return audio(m.content);
  return m.content;
}

function audio(src){
  return `<div class="audio">
    <button onclick="play(this,'${src}')">▶</button>
    <div class="bar"><span></span></div>
  </div>`;
}

window.play=(b,src)=>{
  const a=new Audio(src);
  const bar=b.nextElementSibling.firstChild;
  a.ontimeupdate=()=>bar.style.width=(a.currentTime/a.duration*100)+'%';
  a.onended=()=>b.textContent='▶';
  if(b.textContent==='▶'){b.textContent='■';a.play();}
  else{a.pause();b.textContent='▶';}
};

/* SEND */
$('send-text').onclick=async()=>{
  const t=$('text').value.trim(); if(!t)return;
  const url=editingId?API.edit:API.sendText;
  const body=editingId?{id:editingId,text:t}:{groupId:currentGroup,text:t};
  const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  if(!r.ok)return status(r);
  editingId=null;
  $('text').value=''; loadMessages();
};

window.editMsg=(id,text)=>{editingId=id;$('text').value=text;$('text').focus()};
window.delMsg=async id=>{if(!confirm('Удалить сообщение?'))return; await fetch(API.del,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})}); loadMessages();};

/* FILES */
$('pick-file').onclick=()=>$('file').click();
$('file').onchange=async()=>{
  const f=$('file').files[0]; if(!f)return;
  const fd=new FormData(); fd.append(f.type.startsWith('image')?'image':'voice',f); fd.append('groupId',currentGroup);
  const url=f.type.startsWith('image')?API.img:API.aud;
  const r=await fetch(url,{method:'POST',body:fd});
  if(!r.ok)return status(r);
  $('file').value=''; loadMessages();
};

/* STATUS */
function status(r){$('status').textContent='Ошибка '+r.status;}
</script>

</body>
</html>
