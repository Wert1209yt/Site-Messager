<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Админ Панель</title>
<style>
body {
    font-family: Arial, sans-serif;
    display: flex;
    margin: 0;
    height: 100vh;
}

/* Левая колонка — чаты */
#chatList {
    width: 300px;
    border-right: 1px solid #ccc;
    background: #f0f0f0;
    overflow-y: auto;
    padding: 10px;
}

.chat-card {
    padding: 8px;
    border-bottom: 1px solid #aaa;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    position: relative;
}

.chat-card:hover { background: #e0e0e0; }

.chat-info {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
}

.chat-menu {
    position: absolute;
    top: 28px;
    right: 10px;
    display: none;
    flex-direction: column;
    background: #fff;
    border: 1px solid #aaa;
    z-index: 10;
}

.chat-menu button {
    padding: 5px 10px;
    border: none;
    background: none;
    text-align: left;
    cursor: pointer;
}

.chat-menu button:hover { background: #eee; }

/* Правая колонка — панель действий */
#adminPanel {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
}

h2, h3 { margin-top: 10px; margin-bottom: 5px; }

button { cursor: pointer; margin-top: 3px; }
</style>
</head>
<body>

<div id="chatList">
    <h2>Чаты</h2>
    <div id="chatsContainer"></div>
</div>

<div id="adminPanel">
    <h2>Админ Панель</h2>

    <h3>Список пользователей</h3>
    <ul id="userList"></ul>

    <h3>Удаление сообщения</h3>
    <input type="number" id="messageIndex" placeholder="Индекс сообщения">
    <button onclick="deleteMessage()">Удалить сообщение</button>

    <h3>Отправка сообщения от имени сервера</h3>
    <textarea id="serverMessageInput" placeholder="Введите сообщение"></textarea><br>
    <button onclick="sendServerMessage()">Отправить сообщение</button>

    <h3>Очистка чата</h3>
    <button onclick="clearChat()">Очистить чат</button>
</div>

<script>
let chats = [];
let users = [];

// --- Загрузка всех чатов ---
async function loadChats() {
    const res = await fetch('/admin/chats');
    chats = await res.json();
    const container = document.getElementById('chatsContainer');
    container.innerHTML = '';

    chats.forEach(chat => {
        const card = document.createElement('div');
        card.className = 'chat-card';
        card.dataset.id = chat.id;

        const span = document.createElement('span');
        span.textContent = chat.name;

        const infoBtn = document.createElement('button');
        infoBtn.className = 'chat-info';
        infoBtn.textContent = '⋮';

        const menu = document.createElement('div');
        menu.className = 'chat-menu';
        menu.innerHTML = `
            <button onclick="kickMember(${chat.id})">Кикнуть участника</button>
            <button onclick="showMembers(${chat.id})">Участники</button>
        `;

        infoBtn.onclick = (e) => {
            e.stopPropagation();
            menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
        }

        card.appendChild(span);
        card.appendChild(infoBtn);
        card.appendChild(menu);
        container.appendChild(card);
    });
}

// --- Получение списка пользователей ---
async function fetchUsers() {
    const res = await fetch('/admin/users');
    users = await res.json();
    const ul = document.getElementById('userList');
    ul.innerHTML = '';
    users.forEach(u => {
        const li = document.createElement('li');
        li.textContent = `${u.nickname} - ${u.blocked ? "Заблокирован" : "Активен"}`;
        // Кнопки блокировки/разблокировки рядом
        const blockBtn = document.createElement('button');
        blockBtn.textContent = 'Заблокировать';
        blockBtn.onclick = () => blockUser(u.nickname);

        const unblockBtn = document.createElement('button');
        unblockBtn.textContent = 'Разблокировать';
        unblockBtn.onclick = () => unblockUser(u.nickname);

        li.appendChild(blockBtn);
        li.appendChild(unblockBtn);
        ul.appendChild(li);
    });
}

// --- Блокировка/разблокировка ---
async function blockUser(nick) {
    const res = await fetch('/admin/block-user', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({nickname:nick})
    });
    alert(await res.text());
    fetchUsers();
}
async function unblockUser(nick) {
    const res = await fetch('/admin/unblock-user', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({nickname:nick})
    });
    alert(await res.text());
    fetchUsers();
}

// --- Кик участника ---
async function kickMember(chatId) {
    const member = prompt("Введите ник участника для кика:");
    if (!member) return;
    await fetch('/admin/kick', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({chatId, member})
    });
    alert(`Пользователь ${member} исключён из чата.`);
    loadChats();
}

// --- Показать участников ---
function showMembers(chatId) {
    const chat = chats.find(c => c.id==chatId);
    alert('Участники: ' + chat.members.join(', '));
}

// --- Удаление сообщения ---
async function deleteMessage() {
    const index = document.getElementById("messageIndex").value;
    const res = await fetch('/admin/delete-message', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({index})
    });
    alert(await res.text());
}

// --- Отправка сообщения от сервера ---
async function sendServerMessage() {
    const text = document.getElementById('serverMessageInput').value;
    if (!text.trim()) return alert('Введите сообщение!');
    const res = await fetch('/admin/send-message', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({message:text})});
    alert(await res.text());
    document.getElementById('serverMessageInput').value='';
}

// --- Очистка чата ---
async function clearChat() {
    const res = await fetch('/admin/clear-chat', {method:'POST'});
    alert(await res.text());
}

// --- Инициализация ---
window.onload = async () => {
    await fetchUsers();
    await loadChats();
}
</script>
</body>
</html>
